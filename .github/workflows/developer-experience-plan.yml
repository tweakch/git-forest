name: Developer Experience Plan

# This workflow installs and reconciles the developer-experience plan,
# which optimizes build times, improves error messages, and streamlines
# the development workflow.
#
# Manual Trigger: Use "Run workflow" in the Actions tab
# Auto Trigger: Runs when the plan file is modified

on:
  # Manual trigger
  workflow_dispatch:

  # Trigger on changes to the plan file
  push:
    paths:
      - 'config/plans/team-process/developer-experience.yaml'
    branches:
      - main

  pull_request:
    paths:
      - 'config/plans/team-process/developer-experience.yaml'
    branches:
      - main

permissions:
  contents: read

# Prevent concurrent reconciliation runs
concurrency:
  group: developer-experience-plan-${{ github.ref }}
  cancel-in-progress: false

jobs:
  reconcile-plan:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '10.0.x'

    - name: Restore dependencies
      run: dotnet restore

    - name: Build
      run: dotnet build --no-restore --configuration Release

    - name: Publish CLI
      run: dotnet publish src/GitForest.Cli/GitForest.Cli.csproj --configuration Release --output ./gf-bin

    - name: Add CLI to PATH
      run: echo "${{ github.workspace }}/gf-bin" >> $GITHUB_PATH

    - name: Verify CLI is available
      run: |
        GitForest.Cli --version || echo "CLI version check (may not be implemented yet)"

    - name: Initialize forest
      run: |
        cd ${{ github.workspace }}
        GitForest.Cli init || echo "Forest initialization (may need implementation)"

    - name: Install developer-experience plan
      run: |
        cd ${{ github.workspace }}
        GitForest.Cli plans install config/plans/team-process/developer-experience.yaml

    - name: List installed plans
      run: |
        cd ${{ github.workspace }}
        GitForest.Cli plans list || echo "List plans (may need implementation)"

    - name: Reconcile developer-experience plan
      run: |
        cd ${{ github.workspace }}
        GitForest.Cli plan developer-experience reconcile

    - name: List generated plants
      run: |
        cd ${{ github.workspace }}
        GitForest.Cli plants list --plan developer-experience || echo "List plants (may need implementation)"

    - name: Generate plants report
      run: |
        cd ${{ github.workspace }}
        echo "=== Developer Experience Plan Report ===" > dx-report.txt
        echo "" >> dx-report.txt
        echo "Run Date: $(date)" >> dx-report.txt
        echo "Commit: ${{ github.sha }}" >> dx-report.txt
        echo "Branch: ${{ github.ref }}" >> dx-report.txt
        echo "" >> dx-report.txt
        echo "Generated Plants:" >> dx-report.txt
        GitForest.Cli plants list --plan developer-experience >> dx-report.txt 2>&1 || echo "No plants generated (may need implementation)" >> dx-report.txt
        echo "" >> dx-report.txt
        cat dx-report.txt

    - name: Upload plants report
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: developer-experience-report
        path: dx-report.txt
        retention-days: 30

    - name: Check for high-priority plants
      run: |
        cd ${{ github.workspace }}
        echo "Checking for high-priority developer experience improvements..."
        # This is a placeholder - would check for high-priority plants
        # GitForest.Cli plants list --plan developer-experience --priority high --json
        echo "âœ“ Developer experience reconciliation completed"
